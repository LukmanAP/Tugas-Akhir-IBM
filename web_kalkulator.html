<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator</title>
  <style>
    :root{
      --bg: #0f172a;          /* slate-900 */
      --panel: #111827;       /* gray-900 */
      --surface: #1f2937;     /* gray-800 */
      --muted: #94a3b8;       /* slate-400 */
      --text: #e5e7eb;        /* gray-200 */
      --accent: #22c55e;      /* emerald-500 */
      --accent-2: #3b82f6;    /* blue-500 */
      --danger: #ef4444;      /* red-500 */
      --shadow: rgba(2,6,23,.5);
    }
    .light{
      --bg: #f1f5f9;          /* slate-100 */
      --panel: #ffffff;        /* white */
      --surface: #f8fafc;      /* slate-50 */
      --muted: #475569;        /* slate-600 */
      --text: #0f172a;         /* slate-900 */
      --accent: #16a34a;       /* emerald-600 */
      --accent-2: #2563eb;     /* blue-600 */
      --danger: #dc2626;       /* red-600 */
      --shadow: rgba(15,23,42,.15);
    }

    *{ box-sizing: border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 80% -10%, #0b1220 0%, var(--bg) 60%);
      color: var(--text);
      display:grid; place-items:center; padding:24px;
    }
    .wrap{
      width: min(960px, 100%);
      display:grid; gap:20px;
      grid-template-columns: 1fr 320px;
    }
    @media (max-width: 860px){ .wrap{ grid-template-columns: 1fr } }

    .calc{
      background: linear-gradient(180deg, var(--panel), var(--surface));
      border-radius: 20px; box-shadow: 0 20px 50px var(--shadow);
      padding: 16px; border: 1px solid rgba(255,255,255,.06);
    }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent); }
    .title{ font-weight:700; letter-spacing:.3px }

    .screen{
      margin-top:10px; background: rgba(0,0,0,.18); border-radius: 14px;
      padding: 12px; border:1px solid rgba(255,255,255,.05);
    }
    .expr{ min-height: 28px; font-size: 16px; color: var(--muted); text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .result{ min-height: 48px; font-size: 40px; font-weight:700; text-align:right; letter-spacing:.5px; }

    .keys{ margin-top:12px; display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    button.key{
      -webkit-tap-highlight-color: transparent;
      appearance:none; border:none; cursor:pointer; padding:14px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius: 14px; color:var(--text); font-size:18px; font-weight:600;
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 6px 14px var(--shadow);
      transition: transform .04s ease, filter .2s ease;
    }
    button.key:active{ transform: translateY(1px) }

    .span-2{ grid-column: span 2 }
    .op{ background: linear-gradient(180deg, rgba(59,130,246,.2), rgba(59,130,246,.08)); }
    .eq{ background: linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.1)); }
    .danger{ background: linear-gradient(180deg, rgba(239,68,68,.25), rgba(239,68,68,.1)); }

    .side{
      background: linear-gradient(180deg, var(--panel), var(--surface));
      border-radius: 20px; box-shadow: 0 20px 50px var(--shadow);
      padding: 16px; border: 1px solid rgba(255,255,255,.06);
      min-height: 160px;
    }
    .side h3{ margin:0 0 8px; font-size: 14px; letter-spacing:.4px; color: var(--muted); text-transform:uppercase }
    .history{ max-height: 340px; overflow:auto; display:flex; flex-direction:column; gap:6px; }
    .history button{ text-align:left; width:100%; padding:10px; border-radius:10px; border:1px dashed rgba(255,255,255,.12); background:transparent; color:var(--text); cursor:pointer }
    .history button:hover{ background: rgba(255,255,255,.04) }
    .empty{ color:var(--muted); font-style:italic }

    .toolbar{ display:flex; gap:8px; justify-content:flex-end; }
    .switch{ display:inline-flex; align-items:center; gap:8px; font-size:14px; color:var(--muted) }
    .switch input{ appearance:none; width:42px; height:24px; border-radius:999px; position:relative; background: rgba(255,255,255,.1); outline:none; cursor:pointer; transition: background .2s ease }
    .switch input::after{ content:""; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition: transform .2s ease }
    .switch input:checked{ background: rgba(59,130,246,.5) }
    .switch input:checked::after{ transform: translateX(18px) }

    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
    a.small{ color:var(--muted); font-size:12px; text-decoration:none }
  </style>
</head>
<body>
  <main class="wrap" aria-label="Kalkulator web">
    <section class="calc" role="application" aria-label="Panel kalkulator">
      <div class="topbar">
        <div class="brand"><span class="dot" aria-hidden="true"></span><span class="title">Kalkulator</span></div>
        <div class="toolbar">
          <label class="switch" title="Mode Terang/Gelap">
            <input id="modeToggle" type="checkbox" aria-label="Aktifkan mode terang" />
            <span>Terang</span>
          </label>
        </div>
      </div>

      <div class="screen" aria-live="polite">
        <div id="expr" class="expr" title="Ekspresi"></div>
        <div id="result" class="result" title="Hasil">0</div>
      </div>

      <div class="keys" aria-label="Tombol kalkulator">
        <button class="key danger" data-action="clear" aria-label="Hapus semua (C)">C</button>
        <button class="key" data-action="delete" aria-label="Hapus satu (⌫)">⌫</button>
        <button class="key op" data-value="%" aria-label="Persen">%</button>
        <button class="key op" data-value="/" aria-label="Bagi">÷</button>

        <button class="key" data-value="7">7</button>
        <button class="key" data-value="8">8</button>
        <button class="key" data-value="9">9</button>
        <button class="key op" data-value="*" aria-label="Kali">×</button>

        <button class="key" data-value="4">4</button>
        <button class="key" data-value="5">5</button>
        <button class="key" data-value="6">6</button>
        <button class="key op" data-value="-" aria-label="Kurang">−</button>

        <button class="key" data-value="1">1</button>
        <button class="key" data-value="2">2</button>
        <button class="key" data-value="3">3</button>
        <button class="key op" data-value="+" aria-label="Tambah">+</button>

        <button class="key" data-action="negate" aria-label="Ubah tanda (±)">±</button>
        <button class="key" data-value="0">0</button>
        <button class="key" data-value="." aria-label="Titik desimal">.</button>
        <button class="key eq" data-action="equals" aria-label="Sama dengan (=)">=</button>
      </div>
      <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center; gap:8px">
        <a class="small" href="#" id="copyResult">Salin hasil</a>
        <a class="small" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math" target="_blank" rel="noreferrer">Fungsi Math yang didukung</a>
      </div>
    </section>

    <aside class="side" aria-label="Riwayat perhitungan">
      <h3>Riwayat</h3>
      <div id="history" class="history">
        <div class="empty">Belum ada riwayat. Hasil perhitungan akan muncul di sini.</div>
      </div>
    </aside>
  </main>

  <script>
    (function(){
      const exprEl = document.getElementById('expr');
      const resEl = document.getElementById('result');
      const historyEl = document.getElementById('history');
      const copyEl = document.getElementById('copyResult');
      const modeToggle = document.getElementById('modeToggle');

      let expr = '';
      let justEvaluated = false;
      let history = [];

      // Theme from localStorage
      const savedTheme = localStorage.getItem('calc-theme');
      if(savedTheme === 'light'){ document.documentElement.classList.add('light'); modeToggle.checked = true; }
      modeToggle.addEventListener('change', ()=>{
        document.documentElement.classList.toggle('light', modeToggle.checked);
        localStorage.setItem('calc-theme', modeToggle.checked ? 'light' : 'dark');
      });

      function update(){
        exprEl.textContent = expr.replaceAll('*','×').replaceAll('/','÷');
      }
      function setResult(v){
        const s = (Number.isFinite(v)) ? formatNumber(v) : v;
        resEl.textContent = s;
      }
      function formatNumber(n){
        // Menghindari masalah floating point dan memotong trailing zeros
        const rounded = Math.round((n + Number.EPSILON) * 1e12) / 1e12;
        return rounded.toString().replace(/\.0+$/,'').replace(/(\.\d*?)0+$/,'$1');
      }

      function lastChar(){ return expr.slice(-1) }
      function isOp(ch){ return ['+','-','*','/'].includes(ch) }
      function append(val){
        if(justEvaluated && /[0-9.]/.test(val)){
          expr = ''; // mulai ekspresi baru jika ketik angka setelah '='
        }
        justEvaluated = false;

        // Cegah operator ganda atau titik ganda dalam satu angka
        if(isOp(val)){
          if(expr === '' && val !== '-') return; // tidak boleh mulai dengan operator kecuali '-'
          if(isOp(lastChar())){ expr = expr.slice(0,-1) } // ganti operator terakhir
        }
        if(val === '.'){
          // Cek bagian angka terakhir sudah punya titik atau belum
          const part = expr.split(/(?:[+\-*/])/).pop();
          if(part.includes('.')) return; // abaikan titik kedua
          if(part === '') expr += '0';
        }
        expr += val; update();
      }

      function percent(){
        // terapkan % pada angka terakhir
        const m = expr.match(/^(.*?)([\d.]+)$/);
        if(!m) return;
        const base = m[1]; const n = parseFloat(m[2]);
        if(Number.isFinite(n)){
          expr = base + (n/100).toString(); update();
        }
      }

      function negate(){
        // ubah tanda pada angka terakhir
        const m = expr.match(/^(.*?)([\d.]+)$/);
        if(!m) return;
        const base = m[1]; const part = m[2];
        if(part.startsWith('-')) expr = base + part.slice(1);
        else expr = base + '-' + part;
        update();
      }

      function del(){ expr = expr.slice(0,-1); update(); }
      function clearAll(){ expr = ''; setResult(0); update(); }

      function safeEval(){
        if(expr === '') return 0;
        const clean = expr.replace(/[^0-9+\-*/.()]/g,'');
        if(/^[+*/]/.test(clean)) return NaN; // mulai tidak valid
        if(/[-+*/.]$/.test(clean)) return NaN; // akhir tidak valid
        try{
          // gunakan Function untuk evaluasi terkendali (tanpa scope)
          const val = Function('return (' + clean + ')')();
          return typeof val === 'number' && Number.isFinite(val) ? val : NaN;
        }catch{ return NaN }
      }

      function equals(){
        const val = safeEval();
        if(Number.isNaN(val)){ resEl.textContent = 'Error'; return }
        const prettyExpr = expr.replaceAll('*','×').replaceAll('/','÷');
        setResult(val);
        history.unshift({ e: prettyExpr, r: formatNumber(val) });
        renderHistory();
        expr = String(val); // memungkinkan chaining: 2 + 3 = -> + 4
        justEvaluated = true; update();
      }

      function renderHistory(){
        historyEl.innerHTML = '';
        if(history.length === 0){
          const d = document.createElement('div'); d.className='empty'; d.textContent='Belum ada riwayat.'; historyEl.appendChild(d); return;
        }
        history.slice(0,20).forEach((item, i)=>{
          const btn = document.createElement('button');
          btn.setAttribute('aria-label', 'Gunakan hasil riwayat ' + (i+1));
          btn.innerHTML = `<strong>${item.e}</strong><br/>= ${item.r}`;
          btn.addEventListener('click', ()=>{ expr = item.r; justEvaluated = false; update(); setResult(item.r) });
          historyEl.appendChild(btn);
        });
      }

      // Clipboard
      copyEl.addEventListener('click', (e)=>{
        e.preventDefault();
        const txt = resEl.textContent.trim();
        if(!txt) return;
        navigator.clipboard.writeText(txt).then(()=>{
          copyEl.textContent = 'Tersalin!';
          setTimeout(()=> copyEl.textContent = 'Salin hasil', 1200);
        }).catch(()=>{});
      });

      // Mouse/tap input
      document.querySelectorAll('button.key').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const val = btn.dataset.value;
          const action = btn.dataset.action;
          if(val){ append(val); return }
          if(action === 'equals') return equals();
          if(action === 'clear') return clearAll();
          if(action === 'delete') return del();
          if(action === 'negate') return negate();
        })
      })

      // Keyboard input
      window.addEventListener('keydown', (e)=>{
        const k = e.key;
        if(/^[0-9]$/.test(k)) return append(k);
        if(['+','-','*','/','.'].includes(k)) return append(k);
        if(k === 'Enter' || k === '='){ e.preventDefault(); return equals(); }
        if(k === 'Backspace'){ return del(); }
        if(k === 'Escape'){ return clearAll(); }
        if(k === '%'){ return percent(); }
      });

      // Klik shift-% pada keyboard jadi persen juga
      window.addEventListener('keypress', (e)=>{ if(e.key === '%') percent(); });

      // Klik tombol % pada UI
      document.querySelector('[data-value="%"]').addEventListener('click', percent);

      // Init
      update(); setResult(0); renderHistory();
    })();
  </script>
</body>
</html>
